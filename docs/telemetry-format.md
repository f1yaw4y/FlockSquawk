# Telemetry Format

FlockSquawk outputs structured event data over Serial at 115200 baud. The format depends on the variant.

## JSON Telemetry (all variants except Flipper Zero)

Each detection produces a single JSON object followed by a newline. Generated by `common/TelemetryReporter.h`.

### Schema

```json
{
  "event": "target_detected",
  "ms_since_boot": 15234,
  "source": {
    "radio": "wifi",
    "channel": 6,
    "rssi": -67
  },
  "target": {
    "mac": "58:8e:81:11:22:33",
    "label": "Flock-a1b2c3",
    "certainty": 75,
    "category": "surveillance_device",
    "should_alert": true,
    "detectors": {
      "ssid_format": 75,
      "rssi_modifier": 0
    }
  }
}
```

### Field Reference

| Field | Type | Description |
|-------|------|-------------|
| `event` | string | Always `"target_detected"` |
| `ms_since_boot` | integer | Milliseconds since `TelemetryReporter::initialize()` |
| `source.radio` | string | `"wifi"` or `"bluetooth"` |
| `source.channel` | integer | WiFi channel (0 for BLE) |
| `source.rssi` | integer | Received signal strength in dBm |
| `target.mac` | string | Device MAC address (`xx:xx:xx:xx:xx:xx`) |
| `target.label` | string | SSID (WiFi) or device name (BLE) |
| `target.certainty` | integer | 0-100 confidence score |
| `target.category` | string | `"surveillance_device"` or `"acoustic_detector"` |
| `target.should_alert` | boolean | `true` on first detection above threshold |
| `target.detectors` | object | Which detectors fired and their weights |

### Detector Keys

The `detectors` object only includes detectors that matched. Possible keys:

| Key | Meaning | Typical weight |
|-----|---------|---------------|
| `ssid_format` | Exact SSID pattern match | 75 |
| `ssid_keyword` | SSID keyword substring match | 45 |
| `mac_oui` | MAC OUI prefix match | 20 |
| `ble_name` | BLE device name match | 55 |
| `raven_custom_uuid` | Raven custom UUID match | 80 |
| `raven_std_uuid` | Raven standard UUID match | 10 |
| `rssi_modifier` | RSSI proximity adjustment | -10 to +10 |

### Categories

- `surveillance_device` -- default for WiFi and BLE name/OUI matches
- `acoustic_detector` -- assigned when Raven UUID detectors fire

## Line-Based UART Protocol (Flipper Zero)

The Flipper Zero variant outputs line-based, newline-terminated messages instead of JSON. These are consumed by the companion Flipper app (`flock_scanner.fap`).

### Message Types

```
STATUS,SCANNING
STATUS,BLE_UNSUPPORTED
SEEN,RSSI=-62,MAC=AA:BB:CC:DD:EE:FF,CH=6
ALERT,RSSI=-62,MAC=AA:BB:CC:DD:EE:FF,RADIO=wifi,CH=6,ID=Flock,CERTAINTY=95
CLEAR
```

| Prefix | Purpose |
|--------|---------|
| `STATUS` | System state updates |
| `SEEN` | Raw frame observation (no threat match) |
| `ALERT` | Threat detection with identity and confidence |
| `CLEAR` | No active threats |

### Flipper Notes

- ESP32-S2 has no BLE, so `STATUS,BLE_UNSUPPORTED` is always emitted
- Baud rate: 115200
- UART pins: TX=GPIO43, RX=GPIO44 (wired on the official WiFi Dev Board)
